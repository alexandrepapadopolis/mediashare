name: phosio

services:
  app-dev:
    container_name: phosio-app-dev
    profiles: ["dev"]
    image: node:20-bookworm-slim
    working_dir: /app
    ports:
      - "3000:3000"
      - "3001:3001"

    extra_hosts:
      - "host.docker.internal:host-gateway"
      - "jupiter.local:127.0.0.1"

    env_file:
      - .env

    environment:
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "200"
      NPM_CONFIG_UPDATE_NOTIFIER: "false"
      HOST: 0.0.0.0
      PORT: "3000"
      NODE_ENV: development
      REMIX_DEV_ORIGIN: "http://jupiter.local:3001"

    volumes:
      - .:/app
      - phosio_node_modules:/app/node_modules

    command: >
      sh -lc "
        set -e;
        echo 'Iniciando Phosio Web...';

        NEED_NPM_CI=0;

        if [ ! -d ./node_modules ] || [ ! -x ./node_modules/.bin/remix ]; then
          NEED_NPM_CI=1;
        fi;

        node -e \"require('sharp')\" >/dev/null 2>&1 || NEED_NPM_CI=1;

        if [ \"$$NEED_NPM_CI\" = \"1\" ]; then
          echo 'Instalando toolchain mínima (para dependências nativas, ex.: sharp)...';
          apt-get update;
          apt-get install -y --no-install-recommends python3 make g++;
          rm -rf /var/lib/apt/lists/*;

          echo 'Instalando dependências (npm ci)...';
          npm ci --foreground-scripts --no-audit --no-fund;
        fi;

        exec ./node_modules/.bin/remix dev
      "


  app-prod:
    container_name: phosio-app-prod
    profiles: ["prod"]
    build: .
    env_file:
      - .env
    environment:
      NODE_ENV: production
      PORT: "3000"
      HOST: 0.0.0.0
    ports:
      - "8080:3000"
    restart: unless-stopped

volumes:
  phosio_node_modules:
