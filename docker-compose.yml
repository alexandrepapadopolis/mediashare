name: phosio

services:
  app-dev:
    container_name: phosio-app-dev
    profiles: ["dev"]
    image: node:20-bookworm-slim
    working_dir: /app
    ports:
      - "5173:3000"

    extra_hosts:
      - "host.docker.internal:host-gateway"

    environment:
      SUPABASE_URL: ${SUPABASE_URL:?SUPABASE_URL is required}
      SUPABASE_ANON_KEY: ${SUPABASE_ANON_KEY:?SUPABASE_ANON_KEY is required}
      SESSION_SECRET: ${SESSION_SECRET:?SESSION_SECRET is required}
      VITE_SUPABASE_URL: ${VITE_SUPABASE_URL:?VITE_SUPABASE_URL is required}
      VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY:?VITE_SUPABASE_PUBLISHABLE_KEY is required}
      CHOKIDAR_USEPOLLING: "true"
      CHOKIDAR_INTERVAL: "200"
      NPM_CONFIG_UPDATE_NOTIFIER: "false"
      HOST: 0.0.0.0
      PORT: "3000"

    volumes:
      - .:/app
      - phosio_node_modules:/app/node_modules

    command: >
      sh -lc "
        set -e;
        echo 'Iniciando Phosio Web...';
        if [ ! -x ./node_modules/.bin/remix ]; then
          echo 'Instalando dependÃªncias (npm ci)...';
          npm ci --foreground-scripts --no-audit --no-fund;
        fi;
        ./node_modules/.bin/remix dev
      "

  app-prod:
    container_name: phosio-app-prod
    profiles: ["prod"]
    build:
      context: .
      args:
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_PUBLISHABLE_KEY: ${VITE_SUPABASE_PUBLISHABLE_KEY}
    ports:
      - "8080:80"
    restart: unless-stopped

volumes:
  phosio_node_modules:
